<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A webpage dedicated to the developer team at Ryalto">
    <meta name="author" content="Sergios Papastergiou">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@200;400;500;600&display=swap" rel="stylesheet">

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon/apple-touch-icon.png">
    <link rel="icon" sizes="16x16" href="../assets/images/favicon/favicon-16x16.png">
    <link rel="icon" sizes="32x32" href="../assets/images/favicon/favicon-32x32.png">
    <link rel="icon" sizes="512x512" href="../assets/images/favicon/facicon-512x512.png">

    <!-- Lottie Animation -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

    <!-- favicon here-->
    <script src="https://kit.fontawesome.com/0d939d98c3.js" crossorigin="anonymous"></script>
    <link href="../assets/css/prism.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css" type="text/css">
    <title>Ryalto Developer Page</title>
</head>

<body>
    <!-- Header -->
    <header class="container-fluid">
        <div class="row">
            <div class="col-12 col-sm-4 offset-sm-4 text-center">
                <a href="../index.html">
                    <img src="../assets/images/logos-and-icons/ryalto-logo-lg.png" width="200" height="75.31"
                        alt="ryalto-logo" loading="lazy">
                </a>
            </div>
            <div class="d-none d-sm-inline-block col-4 text-sm-right">
                <ul class="list-inline">
                    <li class="list-inline-item">
                        <a class="social" href="#" target="_blank">
                            <i class="fa-solid fa-globe fa-bounce" style="--fa-animation-iteration-count: 3;"></i>
                        </a>
                    </li>
                    <li class="list-inline-item">
                        <a class="social" href="#" target="_blank">
                            <i class="fa-brands fa-github fa-bounce" style="--fa-animation-iteration-count: 3;"></i>
                        </a>
                    </li>
                    <li class="list-inline-item">
                        <a class="social" href="#" target="_blank">
                            <i class="fa-brands fa-twitter fa-bounce" style="--fa-animation-iteration-count: 3;"></i>
                        </a>
                    </li>
                    <li class="list-inline-item">
                        <a class="social" href="#" target="_blank">
                            <i class="fa-brands fa-linkedin fa-bounce" style="--fa-animation-iteration-count: 3;"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <nav class="navbar navbar-expand">
            <ul class="navbar-nav mx-auto">
                <li class="nav-item">
                    <a class="nav-link" href="../index.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="../blogs-page.html">Blog <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Meet the Team</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Careers</a>
                </li>

            </ul>
        </nav>
    </header>

    <!-- Lottie Animation -->
    <div class="lottie-bg">
        <lottie-player class="lottie-animation"
            src="https://lottie.host/b6ae2926-020e-4c07-aa1c-4b79a653a491/wKjF4OiRZW.json" background="transparent"
            speed="1" loop autoplay></lottie-player>
    </div>

    <!-- Blog Full -->
    <article class="blog-full container-fluid">
        <div class="row">
            <div class="col-12 text-center gen-text">
                <h3>Migrating to GitHub actions for Rails CI</h3>
            </div>
        </div>
        <div class="row author-info pt-2 pb-2 rounded">
            <div class="col-6">
                <img class="author-photo float-right mt-0" src="../assets/images/team/team-member-4.webp" alt="team-member-4">
            </div>
            <div class="col-6 gen-text">
                <h5>Rhil</h5>
                <p>13 October 2022</p>
                <ul class="list-inline">
                    <li class="list-inline-item">
                        <a class="social" href="#" target="_blank"> 
                            <i class="fa-brands fa-github"></i>
                        </a>
                    </li>
                    <li class="list-inline-item">
                        <a class="social" href="#" target="_blank">
                            <i class="fa-brands fa-linkedin"></i>
                        </a>
                    </li>
                    <li class="list-inline-item">
                        <a class="social" href="#" target="_blank">
                            <i class="fa-solid fa-envelope"></i>
                        </a>
                    </li>
                </ul>
            
            </div>
        </div>
        <div class="row">
            <div class="container">
                <div class="row">
                    <div class="col-12 text-justify gen-text">
                        <p>For the last couple of years I‚Äôve been using Ruby.ci to power CI checks on my rails applications. RubyCI is one of those
                        amazing tools that was zero effort to setup and ran flawlessly, it was exactly how I feel that DevOps should be. Sadly,
                        <a href="https://github.com/alexvko" target="_blank">Alex</a> has decided to retire the project and move onto other things.</p>
                        <p>RubyCI is shutting down on October 15th. Alex gave all users a month‚Äôs notice to migrate away to another CI tool, his
                        suggestion was to go with Circle CI, but I decided on GitHub actions. I like the idea of running your CI checks close to
                        your code. GitHub actions are well documented, backed by a strong community and has a well implemented marketplace.
                        Which, after the initial configuration, does make setting things up quite a bit easier.</p>
                        <p>GitHub actions is a lot more flexible than RubyCI, which means that it‚Äôs also a lot more fiddly to set up. There are a
                        few resouces out there which make it simpler, but I coudn‚Äôt find any that completely addressed the setup I was looking
                        for. I did use Matt Swanson‚Äôs Boring Rails guide as a starting point but made some fairly substantial changes. It‚Äôs also
                        worth taking a look at the <a href="https://docs.github.com/en/actions" target="_blank">official documentation</a>.</p>
                        <p>Some useful bookmarks:</p>
                        <ul>
                            <li>
                                <a href="https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-ruby#using-the-ruby-starter-workflow" target="_blank">Ruby Starter Workflow</a>
                            </li>
                            <li>
                                <a href="https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows" target="_blank">Events that trigger workflows</a>
                            </li>
                            <li>
                                <a href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions" target="_blank">Workflow syntax</a>
                            </li>
                            <li>
                                <a href="https://docs.github.com/en/actions/monitoring-and-troubleshooting-workflows/about-monitoring-and-troubleshooting" target="_blank">Monitoring and Troubleshooting</a>
                            </li>
                            <li>
                                <a href="https://docs.github.com/en/actions/using-containerized-services/creating-postgresql-service-containers" target="_blank">Creating Postgres Service</a>
                            </li>
                            <li>
                                <a href="https://docs.github.com/en/actions/using-containerized-services/creating-redis-service-containers" target="_blank">Creating Redis Service</a>
                            </li>
                        </ul>
                        <p>The biggest changes was led by the discovery or ReviewDog, which provides a way to post review comments back on the
                        commit or pull request in GitHub, I was somewhat surprised that GitHub actions didn‚Äôt support this out of the box,
                        considering it‚Äôs part of the same platform, I thought posting comments back on the code would be simple, maybe I missed
                        it? Either way reviewdog handles that for you, and appears to be well used and well supported.</p>
                        <p>I found it easiest to do the intial setup using the GitHub web UI, when you do this GitHub automatically creates a
                            <code class="highlighter-rouge language-plaintext">.github/workflows</code> directory in your project root and the
                            commit to be able to store it.</p>
                        <p>These workflow files are each what you could consider an ‚Äúaction‚Äù. They‚Äôre YAML files which tell the GitHub runner
                            what to do. I created two workflows, one to run all of my code quality and security checks and the other to to run
                            tests. Both of these workflows use a <code class="highlighter-rouge language-plaintext">RAILS_MASTER_KEY</code>
                            environment variable which is stored in the GitHub repo secrets. You can view them both in <a
                                href="https://gist.github.com/phil-6/ab7d185c5ccf02efe8ec86b27c71ae24" target="_blank">this gist</a>, and I‚Äôll include them at
                            the end of the post.</p>
                        <p>The code quality action runs on every push and when a pull request is made to our default branch. It then checks out the
                        code, installs ruby and gems then runs Bundler Audit, Brakeman and Rubocop. Rubocop is actually down twice, once to run
                        on every push and the other runs on pull requests. This is the only way I could configure it to report a green tick and
                        also add comments to a pull request against any failure.</p>
                        <p>The test workflow is a bit more complicated as it has to setup the application to run the tests. It runs on pushes to
                        main, pull requests to main, as well as on workflow dispatch (manually from GitHub web) and on a weekly schedule. Before
                        the rails setup setup, we have to setup Postgres and Redis services. The GitHub docs for setting these up are great. We
                        then repeat the steps to checkout our code and install dependencies. The final steps load our database schema, run the
                        tests, and upload our code coverage to CodeCov (which requires an additional secret).</p>
                        <p>Once these workflows have each run once, you can add them to a branch protection rule in GitHub. This is done in your
                        repo‚Äôs Settings > Branches > Branch protection rules > edit > Require status checks to pass before merging > search for
                        the name of the job.</p>
                        <p>I hope this is enough for you to migrate to GitHub applications. If I‚Äôve missed anything or you think there is anything
                        I should add, please let me know!</p>
                        <h5>Code Quality Workflow</h5>
                        <pre class="highlight language-yaml" tabindex="0"><code class="language-yaml">name: "Code Quality"
                        on:
                          push:
                            branches: [ "**" ]
                          pull_request:
                            branches: [ "main" ]
                            
                        jobs:
                          CodeQuality:
                            runs-on: ubuntu-latest
                            env:
                              RAILS_MASTER_KEY: $
                              
                            steps:
                              # Config
                              - name: Checkout code
                                uses: actions/checkout@v3
                                
                              - name: Install Ruby and gems
                                uses: ruby/setup-ruby@0a29871fe2b0200a17a4497bae54fe5df0d973aa # v1.115.3
                                with:
                                  bundler-cache: true
                              
                              # from https://github.com/tomferreira/action-bundler-audit
                              - name: üìã Bundler audit - Check for vulnerable gems
                                uses: tomferreira/action-bundler-audit@v1
                                with:
                                  bundler_audit_version: gemfile
                                  fail_on_error: true
                                
                              # from https://github.com/reviewdog/action-brakeman
                              - name: üëÆ Brakeman - Security audit application code
                                uses: reviewdog/action-brakeman@v2
                                with:
                                  fail_on_error: true
                                
                              # from https://github.com/reviewdog/action-rubocop
                              - name: ü§ñ Rubocop üö®
                                uses: reviewdog/action-rubocop@v2
                                with:
                                  rubocop_extensions: rubocop-rails rubocop-performance rubocop-minitest
                                  reporter: github-pr-review
                                  fail_on_error: true
                        
                              - name: ü§ñ Rubocop ‚úÖ
                                uses: reviewdog/action-rubocop@v2
                                with:
                                  rubocop_extensions: rubocop-rails rubocop-performance rubocop-minitest
                                  reporter: github-check
                                  fail_on_error: true
                                  
                              # from https://github.com/reviewdog/action-actionlint
                              - name: GitHub Action Lint
                                uses: reviewdog/action-actionlint@v1
                        </code></pre>
                        <h5>Test Workflow</h5>
                        <pre class="highlight language-yaml" tabindex="0"><code class="language-yaml">name: "Minitest"
                        on:
                          push:
                            branches: [ "main" ]
                          pull_request:
                            branches: [ "main" ]
                          workflow_dispatch:
                          schedule:
                            - cron: '0 2 * * 0'
                        
                        jobs:
                          run-tests:
                            runs-on: ubuntu-latest
                        
                            services:
                              postgres:
                                image: postgres:14.5-alpine
                        
                                # Set health checks to wait until postgres has started
                                options: &gt;-
                                  --health-cmd pg_isready
                                  --health-interval 10s
                                  --health-timeout 500ms
                                  --health-retries 15
                        
                                ports:
                                  # Maps port 5432 on service container to the host
                                  - "5432:5432"
                                env:
                                  POSTGRES_DB: rails_test
                                  POSTGRES_USER: rails
                                  POSTGRES_PASSWORD: password
                        
                              redis:
                                image: redis
                        
                                # Set health checks to wait until redis has started
                                options: &gt;-
                                  --health-cmd "redis-cli ping"
                                  --health-interval 10s
                                  --health-timeout 500ms
                                  --health-retries 15
                                  --entrypoint redis-server
                        
                                # Maps port 6379 on service container to the host
                                ports:
                                  - "6379:6379"
                        
                            env:
                              RAILS_ENV: test
                              DATABASE_URL: "postgres://rails:password@localhost:5432/rails_test"
                              RAILS_MASTER_KEY: $
                              REDIS_HOST: localhost
                              REDIS_PORT: 6379
                        
                            steps:
                              - name: Checkout code
                                uses: actions/checkout@v3
                        
                              # Add or replace dependency steps here
                              - name: Install Ruby and gems
                                uses: ruby/setup-ruby@0a29871fe2b0200a17a4497bae54fe5df0d973aa # v1.115.3
                                with:
                                  bundler-cache: true
                        
                              # Add or replace database setup steps here
                              - name: Set up database schema
                                run: bin/rails db:schema:load
                        
                              # Add or replace test runners here
                              - name: Run tests
                                run: bin/rails test
                        
                              - name: Upload coverage to Codecov
                                uses: codecov/codecov-action@v3
                                with:
                                  token: $
                                  verbose: true # optional (default = false)
                        </code></pre>
                    </div>
                </div>
            </div>
        </div>
    </article>

    <!-- Previous/Next Buttons -->
    <div class="container mt-5">
        <div class="row">
            <div class="col-6 text-center ">
                <a href="blog-post-7.html">
                    <button class="btn home-page-btn">Previous</button>
                </a>
            </div>
            <div class="col-6 text-center d-none">
                <button class="btn home-page-btn">Next</button>
            </div>
            <div class="col-6 text-center">
                <p class="inactive">Next</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="container-fluid bg-color-footer mt-5">
        <div class="row">
            <div class="col text-center">
                <a href="index.html">
                    <img src="../assets/images/logos-and-icons/logo-small.png" alt="ryalto-logo-small" width="100"
                        height="100">
                </a>
            </div>
        </div>
        <div class="row">
            <div class="col text-center gen-text">
                <p>¬© Copyright 2023</p>
            </div>
        </div>
    </footer>
    <script src="../assets/js/prism.js"></script>
</body>

</html>